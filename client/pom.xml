<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>bo.gotthardt.dw</groupId>
        <artifactId>dw-experiment</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>

    <artifactId>client</artifactId>
    <name>Dropwizard experiment - Client</name>

    <build>
        <!-- Place all resources under the "assets" folder in the jar. -->
        <resources>
            <resource>
                <directory>src/main/resources</directory>
                <targetPath>assets</targetPath>
            </resource>
            <resource>
                <directory>src/main/img</directory>
                <targetPath>assets/img</targetPath>
            </resource>
            <!-- Minified Javascript and CSS generated by Grunt. -->
            <resource>
                <directory>target/resources</directory>
                <targetPath>assets</targetPath>
            </resource>
        </resources>

        <plugins>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>exec-maven-plugin</artifactId>
                <executions>
                    <!-- Ensure that npm dependencies are installed. TODO does not install grunt-cli, install manually on build server?-->
                    <execution>
                        <id>npm-install</id>
                        <phase>validate</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <executable>npm${executable}</executable>
                            <arguments>
                                <argument>install</argument>
                            </arguments>
                        </configuration>
                    </execution>

                    <!-- Run the Grunt compile phase goal. -->
                    <execution>
                        <id>grunt-compile</id>
                        <phase>compile</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <executable>grunt${executable}</executable>
                            <arguments>
                                <argument>maven-compile</argument>
                            </arguments>
                        </configuration>
                    </execution>

                    <!-- Run the Grunt test phase goal. -->
                    <execution>
                        <id>grunt-test</id>
                        <phase>test</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <executable>grunt${executable}</executable>
                            <arguments>
                                <argument>maven-test</argument>
                            </arguments>
                            <environmentVariables>
                                <PHANTOMJS_BIN>${phantomjs_bin}</PHANTOMJS_BIN>
                            </environmentVariables>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
                <executions>
                    <!-- Disable the default resource plugin execution as it runs before the compile phase where we generate the JS sources. -->
                    <execution>
                        <id>default-resources</id>
                        <phase>none</phase>
                    </execution>

                    <!-- And run it in the compile phase instead. -->
                    <execution>
                        <id>grunt-resources</id>
                        <phase>compile</phase>
                        <goals>
                            <goal>resources</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

    <!-- The exec plugin requires the full filename with .cmd on Windows for npm and grunt.
         And PhantomJS uses two completely different executables.
         So use profiles to define properties with the correct values. -->
    <profiles>
        <profile>
            <id>windows</id>
            <activation>
                <os>
                    <family>windows</family>
                </os>
            </activation>
            <properties>
                <executable>.cmd</executable>
                <phantomjs_bin>node_modules\phantomjs\lib\phantom\phantomjs.exe</phantomjs_bin>
            </properties>
        </profile>

        <profile>
            <id>nix</id>
            <activation>
                <os>
                    <family>!windows</family>
                </os>
            </activation>
            <properties>
                <executable/>
                <phantomjs_bin>node_modules\phantomjs\bin\phantomjs</phantomjs_bin><!-- TODO is this correct? -->
            </properties>
        </profile>
    </profiles>
</project>